Sub InsertWeatherSlide()
    Dim xml As Object
    Dim url As String
    Dim stationID As String
    stationID = "KDAY" ' Dayton Intl Airport — closest to Piqua, OH
    url = "https://forecast.weather.gov/xml/current_obs/" & stationID & ".xml"

    ' Load XML
    Set xml = CreateObject("MSXML2.DOMDocument.6.0")
    xml.async = False
    xml.Load url

    If xml.ParseError.ErrorCode <> 0 Then
        MsgBox "XML load error: " & xml.ParseError.Reason
        Exit Sub
    End If

    ' Extract current condition data
    Dim location As String: location = GetXmlValue(xml, "location")
    Dim temperature As String: temperature = GetXmlValue(xml, "temperature_string")
    Dim weather As String: weather = GetXmlValue(xml, "weather")
    Dim humidity As String: humidity = GetXmlValue(xml, "relative_humidity") & "%"
    Dim wind As String: wind = GetXmlValue(xml, "wind_string")
    Dim obsTime As String: obsTime = GetXmlValue(xml, "observation_time")

    ' Update slide shapes
    Dim sld As Slide
    Set sld = ActivePresentation.Slides(1)

    SafeSetText sld, "WeatherForBox", location
    SafeSetText sld, "TimeBox", obsTime
    SafeSetText sld, "TemperatureBox", temperature
    SafeSetText sld, "WeatherBox", weather
    SafeSetText sld, "HumidityBox", "Humidity: " & humidity
    SafeSetText sld, "WindBox", "Wind: " & wind

    ' Add forecast data
    Call InsertForecastData(sld)
End Sub
Sub InsertForecastData(sld As Slide)
    Dim xml As Object
    Dim lat As String, lon As String
    lat = "40.1445": lon = "-84.2427" ' Piqua, OH

    Dim url As String
    url = "https://forecast.weather.gov/MapClick.php?lat=" & lat & "&lon=" & lon & "&FcstType=dwml"

    Set xml = CreateObject("MSXML2.DOMDocument.6.0")
    xml.async = False
    xml.Load url

    If xml.ParseError.ErrorCode <> 0 Then
        MsgBox "Forecast XML load error: " & xml.ParseError.Reason
        Exit Sub
    End If

    Dim texts As Object
    Set texts = xml.getElementsByTagName("text")
    Dim timeNodes As Object
    Set timeNodes = xml.getElementsByTagName("start-valid-time")

    If texts Is Nothing Or texts.Length = 0 Then
        MsgBox "No forecast data found."
        Exit Sub
    End If

    ' Determine if it’s currently day or night based on hour
    Dim isDaytime As Boolean
    Dim currentHour As Integer
    currentHour = Hour(Now)
    isDaytime = (currentHour >= 6 And currentHour < 18)

    Dim i As Integer
    For i = 0 To 6
        If i >= texts.Length Then Exit For

        Dim wx As String
        wx = texts.Item(i).text

        Dim dayName As String
        If Not timeNodes Is Nothing And i < timeNodes.Length Then
            dayName = timeNodes.Item(i).Attributes.getNamedItem("period-name").text
        Else
            dayName = WeekdayName((Weekday(Date) + i - 1) Mod 7 + 1, True)
        End If

        ' === Emoji matching logic ===
        Dim emojiUrl As String: emojiUrl = ""
        Dim wxLower As String: wxLower = LCase(wx)

        If InStr(wxLower, "snow") > 0 Or InStr(wxLower, "flurries") > 0 Then
            emojiUrl = IIf(isDaytime, "https://img.icons8.com/?size=100&id=qlJRoffslNg7&format=png&color=000000", "https://img.icons8.com/?size=100&id=qlJRoffslNg7&format=png&color=000000")
        ElseIf InStr(wxLower, "clear") > 0 Then
            emojiUrl = IIf(isDaytime, "https://img.icons8.com/?size=100&id=8EUmYhfLPTCF&format=png&color=000000", "https://img.icons8.com/?size=100&id=Opvt5B6x4fI4&format=png&color=000000")
        ElseIf InStr(wxLower, "rain") > 0 Or InStr(wxLower, "showers") > 0 Then
            emojiUrl = IIf(isDaytime, "https://img.icons8.com/?size=100&id=R1kPtXvDMnWj&format=png&color=000000", "https://img.icons8.com/?size=100&id=R1kPtXvDMnWj&format=png&color=000000")
        ElseIf InStr(wxLower, "cloud") > 0 Then
            emojiUrl = IIf(isDaytime, "https://img.icons8.com/?size=100&id=zIVmoh4T8wh7&format=png&color=000000", "https://img.icons8.com/?size=100&id=VT8HlhlnhUwL&format=png&color=000000")
        ElseIf InStr(wxLower, "storm") > 0 Or InStr(wxLower, "thunder") > 0 Then
            emojiUrl = IIf(isDaytime, "https://img.icons8.com/?size=100&id=6AAyqKfBlzoB&format=png&color=000000", "https://img.icons8.com/?size=100&id=6AAyqKfBlzoB&format=png&color=000000")
        ElseIf InStr(wxLower, "fog") > 0 Or InStr(wxLower, "haze") > 0 Or InStr(wxLower, "mist") > 0 Then
            emojiUrl = IIf(isDaytime, "https://img.icons8.com/?size=100&id=39432&format=png&color=000000", "https://img.icons8.com/?size=100&id=7tEHHH5dn7A3&format=png&color=000000")
        ElseIf InStr(wxLower, "hail") > 0 Or InStr(wxLower, "sleet") > 0 Then
            emojiUrl = IIf(isDaytime, "https://img.icons8.com/?size=100&id=39329&format=png&color=000000", "https://img.icons8.com/?size=100&id=39329&format=png&color=000000")
        ElseIf InStr(wxLower, "sun") > 0 Then
            emojiUrl = IIf(isDaytime, "https://img.icons8.com/?size=100&id=8EUmYhfLPTCF&format=png&color=000000", "https://img.icons8.com/?size=100&id=8EUmYhfLPTCF&format=png&color=000000")
        ElseIf InStr(wxLower, "overcast") > 0 Or InStr(wxLower, "cast") > 0 Then
            emojiUrl = IIf(isDaytime, "https://img.icons8.com/?size=100&id=W8fUZZSmXssu&format=png&color=000000", "https://img.icons8.com/?size=100&id=W8fUZZSmXssu&format=png&color=000000")
        End If

        ' === Apply to PowerPoint slide ===
        SafeSetText sld, "Day" & (i + 1) & "Box", dayName
        SafeSetText sld, "Day" & (i + 1) & "CondBox", wx

        If emojiUrl <> "" Then
            On Error Resume Next
            Dim emojiShape As Shape
            Set emojiShape = sld.Shapes.AddPicture(emojiUrl, _
                msoFalse, msoCTrue, _
                60 + (i * 110), 420, 50, 50)
            On Error GoTo 0
        End If
    Next i
End Sub



Function GetXmlValue(xml As Object, tagName As String) As String
    Dim node As Object
    Set node = xml.SelectSingleNode("//" & tagName)
    If Not node Is Nothing Then
        GetXmlValue = node.text
    Else
        GetXmlValue = "N/A"
    End If
End Function

Sub SafeSetText(sld As Slide, shapeName As String, text As String)
    Dim shp As Shape
    ' On Error Resume Next
    Set shp = sld.Shapes(shapeName)
    ' On Error GoTo 0
    If Not shp Is Nothing Then
        shp.TextFrame.TextRange.text = text
    End If
End Sub

